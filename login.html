<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FestifyXR ‚Äî Fest Companion</title>
<style>
  :root{
    --bg:#0b0d12; --elev:#121622; --card:#161b2b; --muted:#8aa0ff55; --text:#eaf0ff; --sub:#adb6d9;
    --brand:#7c9cff; --brand-2:#6af2c6; --red:#ff5d6c; --yellow:#ffd166; --green:#63e6be; --orange:#ff9f43;
    --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1000px 600px at 10% -10%, #1d2340 0%, #0b0d12 60%) fixed; color:var(--text);
  }
  header{
    position:sticky; top:0; z-index:30; backdrop-filter: blur(8px);
    background:linear-gradient(180deg, #0b0d12cc, #0b0d1200);
    border-bottom:1px solid #ffffff10;
  }
  .bar{ max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; align-items:center; gap:14px; }
  .logo{ display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.2px; }
  .logo-badge{
    width:34px; height:34px; border-radius:10px;
    background: conic-gradient(from 120deg, var(--brand), #b488ff, var(--brand-2));
    box-shadow:0 6px 18px #6a89ff55 inset, 0 0 20px #6a89ff55;
  }
  .search{ flex:1; position:relative; }
  .search input{
    width:100%; padding:12px 14px 12px 40px; border-radius:12px; background:var(--elev);
    border:1px solid #ffffff10; color:var(--text); outline:none;
  }
  .search svg{ position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6}
  .nav{ display:flex; gap:8px; flex-wrap:wrap; }
  .nav button{
    background:transparent; color:var(--text); border:1px solid #ffffff12; padding:10px 12px;
    border-radius:10px; cursor:pointer; transition:.2s; font-weight:600;
  }
  .nav button.active, .nav button:hover{ background:#ffffff10; border-color:#ffffff22 }
  main{ max-width:1200px; margin:18px auto 120px; padding:0 18px }
  .grid{ display:grid; gap:16px }
  @media(min-width:900px){ .grid-3{ grid-template-columns: 2fr 1fr 1fr } }
  @media(min-width:900px){ .grid-2{ grid-template-columns: 1.4fr 1fr } }
  .card{
    background:linear-gradient(180deg, #141a2a, #101525); border:1px solid #ffffff12; border-radius:var(--radius);
    box-shadow:var(--shadow); overflow:hidden;
  }
  .card h3{ margin:0; padding:16px; border-bottom:1px solid #ffffff10; display:flex; align-items:center; gap:10px }
  .card .body{ padding:16px }
  .muted{ color:var(--sub); font-size:.95rem }
  .pill{ padding:6px 10px; border-radius:999px; border:1px solid #ffffff20; background:#ffffff08; font-size:.85rem }
  .btn{
    background:linear-gradient(180deg, #6f8dff, #5674ff); color:#070b15; font-weight:800; border:none;
    padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow:0 8px 18px #6f8dff44; transition:.2s;
  }
  .btn.alt{ background:linear-gradient(180deg,#67f1c5,#49d3a7) }
  .btn.ghost{ background:#ffffff10; color:var(--text); border:1px solid #ffffff22; box-shadow:none }
  .list{ display:flex; flex-direction:column; gap:10px }
  .item{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-radius:12px; background:#0f1524; border:1px solid #ffffff0f }
  .item .meta{ display:flex; flex-direction:column; gap:2px }
  .kpis{ display:flex; gap:12px; flex-wrap:wrap }
  .kpi{ background:linear-gradient(180deg, #19213a, #131a2d); border:1px solid #ffffff10; border-radius:14px; padding:14px; min-width:130px; }
  .kpi b{ font-size:1.4rem }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .heatmap{
    position:relative; background:#0d1220; height:360px; border-radius:14px; border:1px solid #ffffff10; overflow:hidden;
    background-image: radial-gradient(#7c9cff11 1px, transparent 1px); background-size: 18px 18px;
  }
  .zone{
    position:absolute; width:110px; height:80px; border-radius:14px; border:1px solid #ffffff20; background:#ffffff08;
    display:flex; align-items:center; justify-content:center; text-align:center; padding:6px; font-weight:700;
  }
  .zone .badge{ position:absolute; right:6px; top:6px; font-size:.8rem; padding:4px 8px; border-radius:999px; background:#00000066 }
  .heat-0{ box-shadow:0 0 0 0 rgba(99,230,190,.45) inset }
  .heat-1{ box-shadow:0 0 0 999in rgba(99,230,190,.06) inset; border-color:#63e6be55 }
  .heat-2{ box-shadow:0 0 0 999in rgba(255,209,102,.08) inset; border-color:#ffd16666 }
  .heat-3{ box-shadow:0 0 0 999in rgba(255,159,67,.10) inset; border-color:#ff9f4366 }
  .heat-4{ box-shadow:0 0 0 999in rgba(255,93,108,.12) inset; border-color:#ff5d6c66 }
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap }
  .toolbar .btn{ padding:8px 10px; font-size:.9rem }
  .toast{
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#101525; color:var(--text);
    padding:12px 16px; border-radius:12px; border:1px solid #ffffff22; box-shadow:var(--shadow); z-index:1000; display:none;
  }
  .chat{ height:400px; overflow:auto; background:#0f1524; border:1px solid #ffffff14; border-radius:14px; padding:12px; }
  .bubble{ max-width:70%; padding:10px 12px; border-radius:12px; margin:10px 0; }
  .me{ background:#22305a; margin-left:auto }
  .bot{ background:#1a233d; border:1px solid #ffffff14 }
  .inputbar{ display:flex; gap:8px; margin-top:10px }
  .inputbar input, .inputbar textarea{
    flex:1; padding:12px; border-radius:12px; background:#0f1524; border:1px solid #ffffff22; color:var(--text); resize:none
  }
  .tag{ font-size:.8rem; padding:4px 8px; border-radius:8px; border:1px solid #ffffff22; background:#ffffff0c }
  canvas#reelCanvas{ width:100%; background:#0f1524; border:1px solid #ffffff14; border-radius:12px }
  small.hint{ color:var(--sub) }
  footer{
    position:fixed; bottom:0; left:0; right:0; background:#0b0d12e0; border-top:1px solid #ffffff10; backdrop-filter: blur(8px);
  }
  .footbar{ max-width:1200px; margin:0 auto; padding:10px 18px; display:flex; align-items:center; justify-content:space-between; gap:10px }
  .footbar .status{ display:flex; gap:12px; align-items:center; }
  .dot{ width:8px; height:8px; border-radius:50%; background:var(--green); box-shadow:0 0 0 4px #63e6be33 }
  a.inline{ color:var(--brand-2); text-decoration:none; border-bottom:1px dashed #67f1c5 }
  /* Auth */
  .auth-container { max-width: 420px; margin: 80px auto; padding: 30px; background: linear-gradient(180deg, #141a2a, #101525); border: 1px solid #ffffff12; border-radius: var(--radius); box-shadow: var(--shadow); }
  .auth-header { text-align: center; margin-bottom: 25px; }
  .auth-header h2 { margin: 0 0 10px; font-size: 28px; background: linear-gradient(90deg, var(--brand), var(--brand-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .auth-tabs { display: flex; margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: var(--elev); }
  .auth-tab { flex: 1; padding: 12px; text-align: center; background: transparent; border: none; color: var(--sub); cursor: pointer; font-weight: 600; transition: all 0.2s; }
  .auth-tab.active { background: var(--brand); color: #070b15; }
  .auth-form { display: none; }
  .auth-form.active { display: block; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; margin-bottom: 6px; color: var(--sub); font-size: 14px; }
  .form-control, .form-select { width: 100%; padding: 12px 14px; border-radius: 12px; background: var(--elev); border: 1px solid #ffffff10; color: var(--text); outline: none; }
  .form-control:focus { border-color: var(--brand); }
  .btn-block { width: 100%; padding: 14px; margin-top: 10px; }
  .auth-footer { text-align: center; margin-top: 20px; font-size: 14px; color: var(--sub); }
  .auth-footer a { color: var(--brand-2); text-decoration: none; }
  .user-menu { position: relative; }
  .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), var(--brand-2)); display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }
  .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 8px; min-width: 180px; background: var(--card); border: 1px solid #ffffff12; border-radius: 12px; box-shadow: var(--shadow); z-index: 100; display: none; }
  .user-dropdown.active { display: block; }
  .user-dropdown a { display: block; padding: 12px 16px; color: var(--text); text-decoration: none; transition: background 0.2s; }
  .user-dropdown a:hover { background: rgba(255, 255, 255, 0.05); }
  .user-dropdown hr { border: none; border-top: 1px solid #ffffff10; margin: 8px 0; }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div>FestifyXR</div>
      <span class="pill">Fest Companion</span>
    </div>
    <div class="search">
      <svg width="18" height="18" fill="none" stroke="currentColor"><circle cx="8" cy="8" r="6" stroke-width="1.5"/><path d="M13 13l4 4" stroke-width="1.5"/></svg>
      <input id="search" placeholder="Search events e.g. 'EDM night' or 'Robo Wars'‚Ä¶">
    </div>
    <nav class="nav" id="nav">
      <button data-view="home" class="active">Home</button>
      <button data-view="events">Events</button>
      <button data-view="plan">My Plan</button>
      <button data-view="map">Map</button>
      <button data-view="rewards">Rewards</button>
      <button data-view="buddy">Buddy</button>
      <button data-view="reel">Memory Reel</button>
      <button data-view="admin" id="adminBtn" style="display:none;">Admin</button>
    </nav>
    <div class="user-menu" id="userMenu" style="display:none;">
      <div class="user-avatar" id="userAvatar">U</div>
      <div class="user-dropdown" id="userDropdown">
        <a href="#" id="profileLink">Profile</a>
        <a href="#" id="settingsLink">Settings</a>
        <hr>
        <a href="#" id="logoutBtn">Logout</a>
      </div>
    </div>
    <button class="btn" id="loginBtn" onclick="showAuth()">Login</button>
  </div>
</header>

<main id="app"></main>

<div id="authContainer" style="display:none;">
  <div class="auth-container">
    <div class="auth-header">
      <h2>Welcome to FestifyXR</h2>
      <p class="muted">Your festival companion app</p>
    </div>

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
      <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>

    <form id="loginForm" class="auth-form active">
      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" class="form-control" placeholder="your@email.com" required>
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
      <div class="form-group">
        <label for="loginRole">Login as</label>
        <select id="loginRole" class="form-select" required>
          <option value="participant">Participant</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="form-group" id="adminPinGroup" style="display:none;">
        <label for="loginAdminPin">Admin PIN</label>
        <input type="password" id="loginAdminPin" class="form-control" placeholder="Enter Admin PIN">
        <small class="muted">Default PIN: <b>2468</b></small>
      </div>
      <button type="submit" class="btn btn-block">Login</button>
    </form>

    <form id="signupForm" class="auth-form">
      <div class="form-group">
        <label for="signupName">Full Name</label>
        <input type="text" id="signupName" class="form-control" placeholder="John Doe" required>
      </div>
      <div class="form-group">
        <label for="signupEmail">Email</label>
        <input type="email" id="signupEmail" class="form-control" placeholder="your@email.com" required>
      </div>
      <div class="form-group">
        <label for="signupPassword">Password</label>
        <input type="password" id="signupPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
      <div class="form-group">
        <label for="signupRole">Sign up as</label>
        <select id="signupRole" class="form-select">
          <option value="participant">Participant</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <button type="submit" class="btn btn-block">Create Account</button>
    </form>

    <div class="auth-footer">
      <p id="authFooterText">Don't have an account? <a href="#" onclick="switchAuthTab('signup')">Sign up</a></p>
    </div>
  </div>
</div>

<footer>
  <div class="footbar">
    <div class="status">
      <div class="dot"></div>
      <div class="muted" id="greet">Welcome!</div>
    </div>
    <div class="row">
      <span class="pill">XP: <b id="xpFoot">0</b></span>
      <button class="btn alt" onclick="openQR()">Scan QR</button>
      <button class="btn ghost" onclick="resetDemo()">Reset Demo</button>
    </div>
  </div>
</footer>

<div class="toast" id="toast"></div>

<script>
/* ========= DATA & STATE ========= */
const SAT = {
  events: [
    {id:'e1', title:'EDM Night', time:'Today 8:00 PM', venue:'Main Stage', tag:'music', points:15, desc:'High-energy set with guest DJ.'},
    {id:'e2', title:'Robo Wars', time:'Today 2:00 PM', venue:'LT-2 Arena', tag:'tech', points:20, desc:'Robots battle in the arena.'},
    {id:'e3', title:'Hackathon Finals', time:'Tomorrow 11:00 AM', venue:'Auditorium', tag:'tech', points:25, desc:'Top teams pitch to judges.'},
    {id:'e4', title:'Comedy Night', time:'Tomorrow 7:30 PM', venue:'Open Air Theatre', tag:'fun', points:10, desc:'Standup acts from campus.'},
    {id:'e5', title:'Food Fest', time:'Today 12:00 PM', venue:'Food Court', tag:'food', points:8, desc:'Stalls from around the city.'},
    {id:'e6', title:'Drone Show', time:'Tomorrow 8:45 PM', venue:'Football Ground', tag:'show', points:18, desc:'Light formations in the sky.'},
  ],
  zones: [
    {id:'z1', name:'Main Stage', x:18, y:18},
    {id:'z2', name:'Food Court', x:58, y:24},
    {id:'z3', name:'LT-2 Arena', x:14, y:62},
    {id:'z4', name:'Auditorium', x:53, y:66},
    {id:'z5', name:'OAT', x:78, y:44}
  ],
  rewards: [
    {id:'r1', title:'Free Coffee', cost:30},
    {id:'r2', title:'Merch ‚Çπ100 Off', cost:60},
    {id:'r3', title:'Backstage Pass', cost:120}
  ],
  qrCatalog: {
    'SAT-EDM-15': {type:'event', ref:'e1', points:15},
    'SAT-ROBO-20': {type:'event', ref:'e2', points:20},
    'SAT-FOOD-5':  {type:'spot', ref:'z2', points:5},
    'SAT-BONUS-25':{type:'bonus', ref:'any', points:25}
  }
};

const store = {
  get: (k, def) => JSON.parse(localStorage.getItem(k) || JSON.stringify(def)),
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
  remove: (k) => localStorage.removeItem(k)
};

const CONFIG = {
  get adminPin(){ return localStorage.getItem('admin_pin') || '2468'; },
  set adminPin(v){ localStorage.setItem('admin_pin', v); }
};

const state = {
  view: 'home',
  user: store.get('sb_user', {name:'Aadit', xp:0, level:1, plan:[], scans:[], zoneCounts:{}, reels:[]}),
};

/* ========= AUTH ========= */
const auth = {
  user: null,
  users: store.get('users', []),

  init() {
    // Ensure an admin exists
    if (this.users.length === 0 || !this.users.some(u => u.role === 'admin')) {
      this.users.push({ id:'admin-1', name:'Fest Admin', email:'admin@festifyxr.com', password:'admin123', role:'admin' });
      store.set('users', this.users);
    }
    // autologin if session exists
    const savedUser = store.get('currentUser', null);
    if (savedUser) { this.user = savedUser; this.updateUI(); }

    // Form hooks
    document.getElementById('loginForm').addEventListener('submit', (e)=>{ e.preventDefault(); this.login(); });
    document.getElementById('signupForm').addEventListener('submit', (e)=>{ e.preventDefault(); this.signup(); });

    // Role toggle shows Admin PIN field
    const roleSel = document.getElementById('loginRole');
    const pinGroup = document.getElementById('adminPinGroup');
    const pinInput = document.getElementById('loginAdminPin');
    roleSel.addEventListener('change', ()=>{
      const adminChosen = roleSel.value === 'admin';
      pinGroup.style.display = adminChosen ? 'block' : 'none';
      if (adminChosen) { pinInput.setAttribute('required','required'); }
      else { pinInput.removeAttribute('required'); pinInput.value=''; }
    });

    // user menu
    document.getElementById('userAvatar').addEventListener('click', () => {
      document.getElementById('userDropdown').classList.toggle('active');
    });
    document.getElementById('logoutBtn').addEventListener('click', (e)=>{ e.preventDefault(); this.logout(); });

    // close dropdown
    document.addEventListener('click', (e)=>{
      if (!e.target.closest('.user-menu')) {
        const dd = document.getElementById('userDropdown'); if (dd) dd.classList.remove('active');
      }
    });
  },

  login(){
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const role = document.getElementById('loginRole').value;
    const adminPinInput = document.getElementById('loginAdminPin').value.trim();

    // Validate email/password/role
    const emailOK = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    if (!emailOK) { toast('Please enter a valid email'); return; }
    if (!password) { toast('Please enter your password'); return; }
    if (!role) { toast('Please select a role'); return; }

    // Find account by email
    const userByEmail = this.users.find(u => u.email.toLowerCase() === email.toLowerCase());
    if (!userByEmail) { toast('No account found for this email'); return; }

    // Check password
    if (userByEmail.password !== password) { toast('Incorrect password'); return; }

    // Enforce role match
    if (userByEmail.role !== role) {
      toast(`This account is "${userByEmail.role}". Please select "${userByEmail.role}".`);
      return;
    }

    // Admin PIN check if logging in as admin
    if (role === 'admin') {
      if (!adminPinInput) { toast('Please enter Admin PIN'); return; }
      const pin = CONFIG.adminPin;
      if (adminPinInput !== pin) { toast('Invalid Admin PIN'); return; }
    }

    // Success ‚Üí set session
    this.user = { id:userByEmail.id, name:userByEmail.name, email:userByEmail.email, role:userByEmail.role };
    store.set('currentUser', this.user);
    this.updateUI();
    hideAuth();
    toast(`Welcome back, ${userByEmail.name}!`);

    // Load user-specific state
    state.user = store.get(`sb_user_${userByEmail.id}`, { name:userByEmail.name, xp:0, level:1, plan:[], scans:[], zoneCounts:{}, reels:[] });

    // Route by role
    if (userByEmail.role === 'admin') { goto('admin'); }
    else { goto('buddy'); }

    setTimeout(()=> addBubble(`Hey ${userByEmail.name}! I‚Äôm FestifyXR üëã Ask me about events, points, or routes.`), 200);
  },

  signup(){
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const role = document.getElementById('signupRole').value;

    if (!name || !email || !password) { toast('Please fill all fields'); return; }
    if (this.users.some(u => u.email.toLowerCase() === email.toLowerCase())) { toast('Email already registered'); return; }

    const newUser = { id:'user-' + Date.now(), name, email, password, role };
    this.users.push(newUser);
    store.set('users', this.users);

    this.user = { id:newUser.id, name:newUser.name, email:newUser.email, role:newUser.role };
    store.set('currentUser', this.user);
    this.updateUI();
    hideAuth();
    toast(`Account created! Welcome, ${name}!`);

    state.user = { name, xp:0, level:1, plan:[], scans:[], zoneCounts:{}, reels:[] };
    store.set(`sb_user_${newUser.id}`, state.user);

    if (newUser.role === 'admin') { goto('admin'); }
    else { goto('buddy'); }
    setTimeout(()=> addBubble(`Hey ${name}! I‚Äôm FestifyXR üëã Ask me about events, points, or routes.`), 200);
  },

  logout(){
    this.user = null;
    store.remove('currentUser');
    this.updateUI();
    showAuth();
    toast('You have been logged out');
  },

  updateUI(){
    const loginBtn = document.getElementById('loginBtn');
    const userMenu = document.getElementById('userMenu');
    const adminBtn = document.getElementById('adminBtn');
    const userAvatar = document.getElementById('userAvatar');
    if (this.user) {
      loginBtn.style.display = 'none';
      userMenu.style.display = 'block';
      userAvatar.textContent = this.user.name.charAt(0).toUpperCase();
      adminBtn.style.display = this.user.role === 'admin' ? 'block' : 'none';
    } else {
      loginBtn.style.display = 'block';
      userMenu.style.display = 'none';
      adminBtn.style.display = 'none';
    }
  }
};

/* ========= AUTH UI ========= */
function showAuth(){ document.getElementById('authContainer').style.display = 'block'; document.getElementById('app').style.display = 'none'; const f=document.querySelector('footer'); if(f) f.style.display='none'; }
function hideAuth(){ document.getElementById('authContainer').style.display = 'none'; document.getElementById('app').style.display = 'block'; const f=document.querySelector('footer'); if(f) f.style.display='block'; }
function switchAuthTab(tab){
  const loginForm = document.getElementById('loginForm'); const signupForm = document.getElementById('signupForm');
  const [loginTab, signupTab] = document.querySelectorAll('.auth-tab');
  const authFooterText = document.getElementById('authFooterText');
  if (tab === 'login') {
    loginForm.classList.add('active'); signupForm.classList.remove('active');
    loginTab.classList.add('active'); signupTab.classList.remove('active');
    authFooterText.innerHTML = 'Don\'t have an account? <a href="#" onclick="switchAuthTab(\'signup\')">Sign up</a>';
  } else {
    loginForm.classList.remove('active'); signupForm.classList.add('active');
    loginTab.classList.remove('active'); signupTab.classList.add('active');
    authFooterText.innerHTML = 'Already have an account? <a href="#" onclick="switchAuthTab(\'login\')">Login</a>';
  }
}

/* ========= UTIL ========= */
const qs = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
function toast(msg, ms=2200){ const t=qs('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); }
function setXP(delta){
  state.user.xp = Math.max(0, (state.user.xp||0) + delta);
  state.user.level = Math.floor(1 + state.user.xp / 100);
  if (auth.user) { store.set(`sb_user_${auth.user.id}`, state.user); } else { store.set('sb_user', state.user); }
  const xpEl = qs('#xpFoot'); if (xpEl) xpEl.textContent = state.user.xp;
}
function greet(){
  const h = new Date().getHours();
  const part = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
  const name = auth.user ? auth.user.name : (state.user?.name || 'Guest');
  const g = qs('#greet'); if (g) g.textContent = `Good ${part}, ${name}!`;
}
function pickHeatClass(n){ return n>=40?'heat-4':n>=28?'heat-3':n>=16?'heat-2':n>=6?'heat-1':'heat-0'; }
function ensureZoneCounts(){
  if(!state.user.zoneCounts) state.user.zoneCounts = {};
  SAT.zones.forEach(z=>{ if(!(z.id in state.user.zoneCounts)) state.user.zoneCounts[z.id]=Math.floor(Math.random()*14); });
  if (auth.user) store.set(`sb_user_${auth.user.id}`, state.user); else store.set('sb_user', state.user);
}

/* ========= ROUTER & VIEWS (unchanged features) ========= */
const VIEWS = {
  home(){ return `
    <div class="grid grid-3">
      <section class="card">
        <h3>Today at a glance ‚ú®</h3>
        <div class="body">
          <div class="kpis">
            <div class="kpi"><div class="muted">XP</div><b>${state.user.xp}</b><div class="muted">Level ${state.user.level}</div></div>
            <div class="kpi"><div class="muted">My Events</div><b>${state.user.plan.length}</b><div class="muted">planned</div></div>
            <div class="kpi"><div class="muted">Rewards</div><b>${SAT.rewards.length}</b><div class="muted">available</div></div>
          </div>
          <div style="height:12px"></div>
          <div class="row">
            <button class="btn" onclick="goto('events')">Browse Events</button>
            <button class="btn alt" onclick="openQR()">Scan QR</button>
            <button class="btn ghost" onclick="goto('map')">Live Crowd Map</button>
          </div>
        </div>
      </section>
      <section class="card">
        <h3>Quick Recommendations üß†</h3>
        <div class="body list">
          ${recommend().map(ev=>eventLine(ev,true)).join('')}
        </div>
      </section>
      <section class="card">
        <h3>Announcements üì£</h3>
        <div class="body">
          <ul>
            <li>Food Court happy hour 4‚Äì5 PM (double XP on scans!)</li>
            <li>Drone Show rehearsal at 6 PM near Football Ground.</li>
            <li>Use <span class="tag">SAT-BONUS-25</span> once per user üòâ</li>
          </ul>
        </div>
      </section>
    </div>
  `;},
  events(){
    const q = (qs('#search')?.value||'').toLowerCase();
    const filtered = SAT.events.filter(e => e.title.toLowerCase().includes(q) || e.tag.includes(q));
    return `
      <section class="card"><h3>All Events</h3><div class="body list">
        ${filtered.map(e => `
          <div class="item">
            <div class="meta"><b>${e.title}</b><span class="muted">${e.time} ¬∑ ${e.venue} ¬∑ <span class="tag">${e.tag}</span></span></div>
            <div class="row">
              <span class="pill">+${e.points} XP</span>
              ${state.user.plan.includes(e.id)
                ? `<button class="btn ghost" onclick="removeFromPlan('${e.id}')">Remove</button>`
                : `<button class="btn" onclick="addToPlan('${e.id}')">Add</button>`}
            </div>
          </div>
        `).join('')}
      </div></section>
    `;
  },
  plan(){
    const planned = SAT.events.filter(e => state.user.plan.includes(e.id));
    return `
      <section class="card"><h3>My Plan</h3><div class="body list">
        ${planned.length? planned.map(e => `
          <div class="item">
            <div class="meta"><b>${e.title}</b><span class="muted">${e.time} ¬∑ ${e.venue}</span></div>
            <div class="row">
              <button class="btn ghost" onclick="navToVenue('${e.venue}')">Navigate</button>
              <button class="btn" onclick="checkInEvent('${e.id}')">Check-in (+${e.points} XP)</button>
              <button class="btn ghost" onclick="removeFromPlan('${e.id}')">Remove</button>
            </div>
          </div>
        `).join('') : `<div class="muted">No events yet. Go to <a class="inline" href="#" onclick="goto('events')">Events</a> to add some.</div>`}
      </div></section>
    `;
  },
  map(){
    ensureZoneCounts();
    return `
      <section class="card"><h3>Live Crowd Heatmap</h3>
      <div class="body">
        <div class="toolbar">
          <button class="btn" onclick="pingHere()">I am here (contribute)</button>
          <button class="btn ghost" onclick="decrowd()">Clear crowd (demo)</button>
        </div>
        <div style="height:10px"></div>
        <div class="heatmap" id="heat">
          ${SAT.zones.map(z=>{
            const n = state.user.zoneCounts[z.id]||0;
            return `
              <div class="zone ${pickHeatClass(n)}" style="left:${z.x}%; top:${z.y}%">
                <span class="badge">${n}</span>${z.name}
              </div>
            `;
          }).join('')}
        </div>
        <div style="height:10px"></div>
        <div class="muted">Tip: press ‚ÄúI am here‚Äù near a zone to simulate anonymous pings. Colors: green ‚Üí calm, red ‚Üí crowded.</div>
      </div></section>
    `;
  },
  rewards(){
    const scans = state.user.scans||[];
    return `
      <div class="grid grid-2">
        <section class="card"><h3>Rewards Center üéÅ</h3><div class="body list">
          ${SAT.rewards.map(r=>`
            <div class="item">
              <div class="meta"><b>${r.title}</b><span class="muted">${r.cost} XP</span></div>
              <div class="row"><button class="btn" ${state.user.xp<r.cost?'disabled':''} onclick="redeem('${r.id}')">Redeem</button></div>
            </div>
          `).join('')}
        </div></section>
        <section class="card"><h3>Scan History</h3><div class="body list">
          ${scans.length? scans.slice().reverse().map(s=>`
            <div class="item">
              <div class="meta"><b>${s.code}</b><span class="muted">${s.time}</span></div>
              <span class="pill">+${s.points} XP</span>
            </div>
          `).join('') : `<div class="muted">No scans yet. Use the <b>Scan QR</b> button below.</div>`}
        </div></section>
      </div>
    `;
  },
  buddy(){
    return `
      <div class="grid grid-2">
        <section class="card"><h3>Buddy Chat ü§ñ</h3>
          <div class="body">
            <div class="chat" id="chat"></div>
            <div class="inputbar">
              <input id="chatInput" placeholder="Ask me anything: 'Where is Robo Wars?' 'What‚Äôs my XP?'" onkeydown="if(event.key==='Enter') sendMsg()">
              <button class="btn" onclick="sendMsg()">Send</button>
              <button class="btn alt" id="voiceBtn" onclick="toggleVoice()">üéôÔ∏è Voice</button>
            </div>
            <div style="height:8px"></div>
            <div class="row muted">
              <span class="tag">try: ‚Äúevents for music‚Äù</span>
              <span class="tag">‚Äúadd EDM Night‚Äù</span>
              <span class="tag">‚Äúscan SAT-BONUS-25‚Äù</span>
            </div>
          </div>
        </section>
        <section class="card"><h3>Quick Actions</h3>
          <div class="body list">
            <div class="item"><div class="meta"><b>AR Poster (demo)</b><span class="muted">Open camera & overlay info (mock)</span></div><button class="btn ghost" onclick="demoAR()">Try</button></div>
            <div class="item"><div class="meta"><b>Lost & Found (demo)</b><span class="muted">Image similarity mock</span></div><button class="btn ghost" onclick="lostFound()">Open</button></div>
            <div class="item"><div class="meta"><b>Invite Friends</b><span class="muted">Share this page URL</span></div><span class="pill">No login needed</span></div>
          </div>
        </section>
      </div>
    `;
  },
  reel(){
    return `
      <section class="card"><h3>Memory Reel Maker üéûÔ∏è</h3>
        <div class="body">
          <div class="row">
            <input type="file" id="reelFiles" accept="image/*" multiple>
            <button class="btn" onclick="previewReel()">Preview</button>
            <button class="btn alt" onclick="recordReel()">Export .webm</button>
          </div>
          <div style="height:10px"></div>
          <small class="hint">Tip: pick 5‚Äì10 images. We‚Äôll auto crossfade and add a subtle zoom effect. Exports entirely in-browser.</small>
          <div style="height:10px"></div>
          <canvas id="reelCanvas" width="800" height="450"></canvas>
        </div>
      </section>
    `;
  },
  admin(){
    if (!auth.user || auth.user.role !== 'admin') { return '<div class="card"><div class="body"><p>Access denied. Admin privileges required.</p></div></div>'; }
    const users = auth.users;
    const participants = users.filter(u => u.role === 'participant');
    const admins = users.filter(u => u.role === 'admin');
    return `
      <div class="grid grid-2">
        <section class="card"><h3>User Management</h3>
          <div class="body">
            <div class="kpis">
              <div class="kpi"><div class="muted">Total Users</div><b>${users.length}</b></div>
              <div class="kpi"><div class="muted">Participants</div><b>${participants.length}</b></div>
              <div class="kpi"><div class="muted">Admins</div><b>${admins.length}</b></div>
            </div>
            <div style="height:16px"></div>
            <div class="toolbar">
              <button class="btn" onclick="exportUserData()">Export Data</button>
              <button class="btn alt" onclick="resetAllData()">Reset All Data</button>
            </div>
            <div style="height:16px"></div>
            <div class="form-group">
              <label>Set Admin PIN</label>
              <div class="row">
                <input id="newAdminPin" class="form-control" placeholder="New PIN (4-8 digits)" style="max-width:220px">
                <button class="btn" onclick="updateAdminPin()">Update PIN</button>
              </div>
              <small class="muted">Current PIN: <b>${CONFIG.adminPin}</b></small>
            </div>
          </div>
        </section>
        <section class="card"><h3>Recent Activity</h3>
          <div class="body list">
            <div class="item"><div class="meta"><b>New user registration</b><span class="muted">Just now</span></div><span class="pill">Participant</span></div>
            <div class="item"><div class="meta"><b>QR code scanned</b><span class="muted">5 mins ago</span></div><span class="pill">+15 XP</span></div>
            <div class="item"><div class="meta"><b>Event check-in</b><span class="muted">12 mins ago</span></div><span class="pill">EDM Night</span></div>
          </div>
        </section>
        <section class="card"><h3>Participants</h3>
          <div class="body list">
            ${participants.map(u => `
              <div class="item">
                <div class="meta"><b>${u.name}</b><span class="muted">${u.email}</span></div>
                <div class="row">
                  <span class="pill">XP: ${store.get(`sb_user_${u.id}`, {xp:0}).xp}</span>
                  <button class="btn ghost" onclick="viewUserDetails('${u.id}')">View</button>
                </div>
              </div>
            `).join('')}
          </div>
        </section>
        <section class="card"><h3>System Stats</h3>
          <div class="body">
            <div class="list">
              <div class="item"><div class="meta"><b>Total Events</b></div><span class="pill">${SAT.events.length}</span></div>
              <div class="item"><div class="meta"><b>Total Scans</b></div><span class="pill">${users.reduce((sum, u) => sum + (store.get(`sb_user_${u.id}`, {scans:[]}).scans.length), 0)}</span></div>
              <div class="item"><div class="meta"><b>Active Zones</b></div><span class="pill">${SAT.zones.length}</span></div>
            </div>
          </div>
        </section>
      </div>
    `;
  }
};

function goto(view){ state.view = view; qsa('#nav button').forEach(b => b.classList.toggle('active', b.dataset.view===view)); render(); }
function render(){
  const app = qs('#app'); if (app) app.innerHTML = VIEWS[state.view]();
  const xpEl = qs('#xpFoot'); if (xpEl) xpEl.textContent = state.user.xp;
  greet();
}

/* ========= Features (unchanged helper functions) ========= */
function eventLine(e){ return `
  <div class="item">
    <div class="meta"><b>${e.title}</b><span class="muted">${e.time} ¬∑ ${e.venue} ¬∑ <span class="tag">${e.tag}</span></span></div>
    <div class="row">
      <span class="pill">+${e.points} XP</span>
      ${state.user.plan.includes(e.id)
        ? `<button class="btn ghost" onclick="removeFromPlan('${e.id}')">Remove</button>`
        : `<button class="btn" onclick="addToPlan('${e.id}')">Add</button>`}
    </div>
  </div>`; }
function recommend(){ return SAT.events.filter(e=>!state.user.plan.includes(e.id)).sort((a,b)=>b.points-a.points).slice(0,3); }
function addToPlan(id){ if(!state.user.plan.includes(id)) state.user.plan.push(id); if (auth.user) store.set(`sb_user_${auth.user.id}`, state.user); else store.set('sb_user', state.user); toast('Added to plan ‚úÖ'); render(); }
function removeFromPlan(id){ state.user.plan = state.user.plan.filter(x=>x!==id); if (auth.user) store.set(`sb_user_${auth.user.id}`, state.user); else store.set('sb_user', state.user); render(); }
function navToVenue(venue){ toast(`Opening navigation to ${venue}‚Ä¶`); const q = encodeURIComponent(venue + ' Thapar University'); window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, '_blank'); }
function checkInEvent(id){ const e = SAT.events.find(x=>x.id===id); if(!e) return; setXP(e.points); logScan({code:`CHECKIN-${id}`, points:e.points}); toast(`Checked in to ${e.title}! +${e.points} XP üéâ`); render(); }

/* ========= QR + Map + Chat (same as before) ========= */
let camStream=null;
function openQR(){ const code = prompt("Demo QR: try SAT-EDM-15, SAT-ROBO-20, SAT-FOOD-5, SAT-BONUS-25\n\n(Optional) Enter code manually:"); if(code){ processQR(code); return; } }
function processQR(code){
  const key = String(code).trim().toUpperCase(); const entry = SAT.qrCatalog[key];
  if(!entry){ toast('Invalid QR'); return; }
  if((state.user.scans||[]).find(s=>s.code===key)){ toast('Already scanned'); return; }
  setXP(entry.points); logScan({code:key, points:entry.points});
  if(entry.type==='event'){ if(!state.user.plan.includes(entry.ref)) state.user.plan.push(entry.ref); }
  else if(entry.type==='spot'){ ensureZoneCounts(); state.user.zoneCounts['z2'] = (state.user.zoneCounts['z2']||0) + 8; }
  if (auth.user) store.set(`sb_user_${auth.user.id}`, state.user); else store.set('sb_user', state.user);
  toast(`+${entry.points} XP üéâ`); render();
}
function logScan(s){ const t = new Date().toLocaleString(); state.user.scans = state.user.scans||[]; state.user.scans.push({...s, time:t}); if (auth.user) store.set(`sb_user_${auth.user.id}`, state.user); else store.set('sb_user', state.user); }
function pingHere(){ ensureZoneCounts(); const z = SAT.zones[Math.floor(Math.random()*SAT.zones.length)]; state.user.zoneCounts[z.id] = (state.user.zoneCounts[z.id]||0) + 3 + Math.floor(Math.random()*4); if (auth.user) store.set(`sb_user_${auth.user.id}`, state.user); else store.set('sb_user', state.user); toast('Pinged near ' + z.name); if(state.view==='map') render(); }
function decrowd(){ ensureZoneCounts(); Object.keys(state.user.zoneCounts).forEach(k=> state.user.zoneCounts[k] = Math.max(0, state.user.zoneCounts[k]-10)); if (auth.user) store.set(`sb_user_${auth.user.id}`, state.user); else store.set('sb_user', state.user); if(state.view==='map') render(); }

/* Chat */
const chatEl = ()=>qs('#chat');
function addBubble(txt, who='bot'){ const box = chatEl(); if(!box) return; const d = document.createElement('div'); d.className = 'bubble ' + (who==='me'?'me':'bot'); d.textContent = txt; box.appendChild(d); box.scrollTop = box.scrollHeight; }
function matchEvent(nameLike){ const q = nameLike.toLowerCase(); return SAT.events.find(e => e.title.toLowerCase() === q) || SAT.events.find(e => e.title.toLowerCase().includes(q)); }
function botReply(raw){
  const q = raw.trim(); const low = q.toLowerCase();
  if(/^hi$|^hello$|^hey$|help|^\?$/.test(low)){ return 'Hey! I‚Äôm FestifyXR üëã Try ‚Äúevents for music‚Äù, ‚Äúmy points‚Äù, ‚Äúadd EDM Night‚Äù, ‚Äúnavigate to Main Stage‚Äù, or ‚Äúscan SAT-BONUS-25‚Äù.'; }
  if(/\b(xp|points|score|level)\b/.test(low)){ return `You have ${state.user.xp} XP and are Level ${state.user.level}.`; }
  const tag = ['music','tech','fun','food','show'].find(t=> low.includes(t));
  if(/\bevents?\b|\bshow(s)?\b|\blist\b/.test(low)){ const list = tag? SAT.events.filter(e=>e.tag===tag) : SAT.events; return 'Here are some ' + (tag||'top') + ' picks: ' + list.slice(0,3).map(e=>e.title).join(', ') + '.'; }
  if(/\b(schedule|plan|my events)\b/.test(low)){ const mine = SAT.events.filter(e=>state.user.plan.includes(e.id)); return mine.length? 'You planned: ' + mine.map(e=>e.title).join(', ') + '.' : 'Your plan is empty. Say ‚Äúadd EDM Night‚Äù.'; }
  const addMatch = low.match(/^add (.+)$/); if(addMatch){ const ev = matchEvent(addMatch[1]); if(!ev) return 'Couldn\'t find that event. Try exact name like ‚ÄúEDM Night‚Äù.'; if(!state.user.plan.includes(ev.id)) addToPlan(ev.id); return 'Added ' + ev.title + ' to your plan. ‚úÖ'; }
  const remMatch = low.match(/^remove (.+)$/); if(remMatch){ const ev = matchEvent(remMatch[1]); if(!ev) return 'Couldn\'t find that event.'; removeFromPlan(ev.id); return 'Removed ' + ev.title + ' from your plan.'; }
  if(/\b(where|navigate|route|directions|take me to)\b/.test(low)){ const ev = SAT.events.find(e => low.includes(e.title.toLowerCase())); const z = SAT.zones.find(z => low.includes(z.name.toLowerCase())); if(ev){ navToVenue(ev.venue); return 'Opening navigation to ' + ev.venue + ' for ' + ev.title + '‚Ä¶'; } if(z){ navToVenue(z.name); return 'Opening navigation to ' + z.name + '‚Ä¶'; } return 'Tell me the event or venue, e.g., ‚Äúnavigate to Main Stage‚Äù.'; }
  const scanMatch = low.match(/^scan\s+([a-z0-9-]+)/i); if(scanMatch){ processQR(scanMatch[1]); return 'Scanning ' + scanMatch[1].toUpperCase() + '‚Ä¶'; }
  const checkMatch = low.match(/^check ?-?in (?:to )?(.+)/); if(checkMatch){ const ev = matchEvent(checkMatch[1]); if(!ev) return 'Tell me the exact event to check in.'; checkInEvent(ev.id); return 'Checked in to ' + ev.title + '! (+' + ev.points + ' XP)'; }
  return 'Got it! Try ‚Äúmy points‚Äù, ‚Äúevents for tech‚Äù, ‚Äúadd Robo Wars‚Äù, or ‚Äúnavigate to Auditorium.‚Äù';
}
function sendMsg(){ const i = qs('#chatInput'); if(!i) return; const v = i.value.trim(); if(!v) return; addBubble(v,'me'); i.value=''; setTimeout(()=>{ const r = botReply(v); addBubble(r,'bot'); }, 150); }

/* Admin helpers */
function updateAdminPin(){
  const v = (document.getElementById('newAdminPin').value || '').trim();
  if(!/^\d{4,8}$/.test(v)){ toast('PIN must be 4‚Äì8 digits'); return; }
  CONFIG.adminPin = v; toast('Admin PIN updated'); if (state.view==='admin') render();
}
function redeem(id){ const r = SAT.rewards.find(x=>x.id===id); if(!r) return; if(state.user.xp < r.cost){ toast('Not enough XP'); return; } setXP(-r.cost); toast('Redeemed: ' + r.title + ' üéâ'); render(); }
function resetDemo(){ if (auth.user) { state.user = { name: auth.user.name, xp:0, level:1, plan:[], scans:[], zoneCounts:{}, reels:[] }; store.set('sb_user_' + auth.user.id, state.user); toast('Your data has been reset'); render(); } else { localStorage.removeItem('sb_user'); state.user = {name:'Aadit', xp:0, level:1, plan:[], scans:[], zoneCounts:{}, reels:[]}; toast('Demo reset'); render(); } }
function exportUserData(){ const data = { users: auth.users, userData: {} }; auth.users.forEach(u => { data.userData[u.id] = store.get('sb_user_' + u.id, {}); }); const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'festifyxr-data.json'; a.click(); toast('Data exported successfully'); }
function resetAllData(){ if (confirm('Are you sure you want to reset all user data? This cannot be undone.')) { auth.users.forEach(u => { store.remove('sb_user_' + u.id); }); auth.users = [{ id: 'admin-1', name: 'Fest Admin', email: 'admin@festifyxr.com', password: 'admin123', role: 'admin' }]; store.set('users', auth.users); toast('All user data has been reset'); render(); } }
function viewUserDetails(userId){ const user = auth.users.find(u => u.id === userId); const userData = store.get('sb_user_' + userId, {}); alert('User: ' + user.name + '\nEmail: ' + user.email + '\nXP: ' + (userData.xp || 0) + '\nLevel: ' + (userData.level || 1) + '\nEvents Planned: ' + (userData.plan ? userData.plan.length : 0)); }

// Router bindings
document.getElementById('search')?.addEventListener('input', ()=>{ if(state.view==='events') render(); });
Array.from(document.querySelectorAll('#nav button')).forEach(b=> b.addEventListener('click', ()=>goto(b.dataset.view)));

function init(){
  auth.init();
  if (!auth.user) {
    showAuth();
  } else {
    greet();
    render();
    setTimeout(() => {
      if (state.view === 'home') {
        goto('buddy');
        setTimeout(() => { addBubble('Hey ' + auth.user.name + '! I‚Äôm FestifyXR üëã Ask me about events, points, or routes.'); }, 300);
      }
    }, 600);
  }
}
init();
</script>
</body>
</html>
